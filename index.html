<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curtain Quote App - Centered Summary</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai+Looped:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main: #2c3e50; --gold: #d4af37; --danger: #e74c3c; --green: #06C755; --bg: #f0f2f5; --accent: #34495e; }
        body { font-family: 'Noto Sans Thai Looped', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .app-card { background: white; width: 100%; max-width: 500px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 120px; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f8f9fa; padding-bottom: 15px; }
        .item-card { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin-bottom: 15px; position: relative; border-left: 5px solid var(--main); }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; }
        .item-number { background: var(--main); color: white; padding: 2px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .room-name-top { flex: 1; margin-bottom: 0 !important; padding: 5px 10px !important; font-size: 14px !important; border-style: dashed !important; height: 32px; }
        .btn-remove-x { background: #fff0f0; color: var(--danger); border: 1px solid #ffebeb; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; line-height: 1; }
        .btn-remove-x:hover { background: var(--danger); color: white; transform: translateY(-2px); }
        label { display: block; margin-bottom: 5px; font-weight: 700; color: var(--main); font-size: 13px; }
        select, input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1.5px solid #eee; border-radius: 10px; box-sizing: border-box; font-family: inherit; font-size: 16px; transition: border 0.2s; }
        .row { display: flex; gap: 10px; margin-bottom: 5px; }
        .row div { flex: 1; }
        .size-entry { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 10px; position: relative; }
        .btn-remove-size { position: absolute; right: -5px; top: -5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; }
        .btn-add-set { background: none; border: 1px dashed var(--main); color: var(--main); width: 100%; padding: 8px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: bold; margin-bottom: 15px; transition: 0.2s; }
        .btn-add-set:hover { background: #f0f2f5; }
        .bottom-row { display: flex; justify-content: flex-end; align-items: flex-end; margin-top: 10px; gap: 10px; }
        .price-display { text-align: right; color: var(--gold); font-weight: bold; font-size: 15px; margin-top: 5px; }
        .option-box-small { background: #fdfaf0; padding: 8px; border-radius: 8px; border: 1px dashed var(--gold); margin-top: 5px; display: flex; gap: 15px; transition: background 0.2s; }
        .check-item { display: flex; align-items: center; font-size: 13px; cursor: pointer; }
        .check-item input { width: 16px; height: 16px; margin-right: 6px; accent-color: var(--gold); margin-bottom: 0; }
        .btn-add { width: 100%; padding: 15px; background: var(--main); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .total-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); display: flex; justify-content: center; z-index: 100; }
        .footer-content { width: 100%; max-width: 470px; display: flex; flex-direction: column; gap: 10px; }
        .price-row { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
        .btn-summary { width: 100%; padding: 18px; background: var(--gold); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }

        /* การตั้งค่าหน้าต่างสรุปให้อยู่ตรงกลาง */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100vw; height: 100vh; 
            background: rgba(0,0,0,0.7); 
            z-index: 9999; 
            justify-content: center; /* กลางแนวนอน */
            align-items: center;     /* กลางแนวตั้ง */
            padding: 15px;
            box-sizing: border-box;
        }
        .modal-content { 
            background: white; 
            width: 100%; 
            max-width: 450px; 
            border-radius: 24px; 
            max-height: 90vh; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .summary-body { padding: 25px; background: white; overflow-y: auto; flex: 1; }
        .summary-item { border-bottom: 1.5px solid #f0f0f0; padding: 15px 0; font-size: 14px; }
        .summary-title { font-weight: bold; color: var(--main); font-size: 16px; display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .type-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-right: 8px; display: inline-block; color: white; font-weight: bold; }
        .summary-detail { display: flex; justify-content: space-between; color: #444; font-size: 13px; margin-top: 4px; border-left: 2px solid #eee; padding-left: 10px; }
        .summary-total { font-size: 22px; font-weight: bold; color: var(--gold); text-align: center; margin-top: 20px; border-top: 2px solid var(--main); padding-top: 15px; }
        .min-warning { color: var(--danger); font-size: 11px; display: block; margin-top: 4px; font-weight: bold; }
        
        /* สถานะแจ้งเตือนความผิดพลาด */
        .input-error { border: 1.5px solid var(--danger) !important; background: #fff6f6; }
        .option-error { border: 1px solid var(--danger) !important; background: #fff6f6 !important; }

        .btn-save-icon { position: absolute; top: 20px; right: 20px; background: var(--green); color: white; border: none; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(6,199,85,0.3); z-index: 100; }
        .btn-group { padding: 20px; background: #fafafa; border-top: 1px solid #eee; }
        .close-modal { width: 100%; padding: 15px; background: #eee; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: #666; font-size: 16px; }
        .hide-on-capture { display: none !important; }
    </style>
</head>
<body>

<div class="app-card">
    <div class="header">
        <h1 style="font-size: 24px; color: var(--main); margin: 0;">THE CORNER CURTAIN</h1>
        <p style="font-size: 13px; color: #7f8c8d; margin: 5px 0 0;">โปรแกรมคำนวนราคาเบื้องต้น</p>
    </div>
    <div id="itemList"></div>
    <button class="btn-add" onclick="addItem()">
        <span style="font-size: 22px; line-height: 0;">+</span> เพิ่มรายการใหม่
    </button>
</div>

<div class="total-bar">
    <div class="footer-content">
        <div class="price-row">
            <span style="font-size: 14px; color: #7f8c8d;">ยอดรวมทั้งหมด:</span>
            <span id="total-amount-show" style="font-size: 24px; color: var(--main); font-weight: bold;">0.-</span>
        </div>
        <button class="btn-summary" onclick="validateAndShowSummary()">สรุปรายการทั้งหมด</button>
    </div>
</div>

<div id="summaryModal" class="modal">
    <div class="modal-content">
        <button class="btn-save-icon" onclick="saveImage()" title="บันทึกรูปภาพ">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
        </button>
        <div id="capture-area" class="summary-body">
            <h2 style="text-align: center; color: var(--main); margin: 0 0 20px 0; border-bottom: 2px solid var(--gold); padding-bottom: 10px; font-size: 24px;">สรุปรายการ</h2>
            <div id="summaryList"></div>
            <div id="summaryGrandTotal" class="summary-total"></div>
        </div>
        <div class="btn-group">
            <button class="close-modal" onclick="closeModal()">ย้อนกลับ</button>
        </div>
    </div>
</div>

<script>
    const curtainPrices = {
        "ม่านตาไก่": { main: 1400, sheer: 1200, calc: "width", color: "#3498db" },
        "ม่านจีบ": { main: 1600, sheer: 1400, calc: "width", color: "#9b59b6" },
        "ม่านลอน": { main: 1800, sheer: 1600, calc: "width", color: "#2ecc71" },
        "ม่านพับ": { main: 2000, sheer: 1800, calc: "width", color: "#1abc9c" },
        "ม่านม้วน": { price: 1000, calc: "sqyard", min: 1.80, color: "#e67e22" },
        "มู่ลี่ไม้": { price: 2190, calc: "sqyard", min: 1.50, color: "#8b4513" },
        "มู่ลี่อลูมิเนียม": { price: 890, calc: "sqyard", min: 1.80, color: "#7f8c8d" },
        "ฉากกั้นห้อง PVC": { price: 890, calc: "sqyard", min: 2.50, color: "#e74c3c" }
    };

    function addItem() {
        const id = Date.now();
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item-card';
        itemDiv.id = `item-${id}`;
        itemDiv.innerHTML = `
            <div class="item-header">
                <span class="item-number">รายการที่ </span>
                <input type="text" class="room-name room-name-top" placeholder="ใส่ชื่อห้อง / หมายเหตุ">
                <div class="btn-remove-x" onclick="removeItem('${id}')">×</div>
            </div>
            <label>ประเภทม่าน</label>
            <select class="curtain-type" onchange="resetError(this); updateUIForType('${id}'); updatePrices();">
                <option value="">เลือกประเภท...</option>
                <option>ม่านตาไก่</option><option>ม่านจีบ</option>
                <option>ม่านลอน</option><option>ม่านพับ</option>
                <option>ม่านม้วน</option><option>มู่ลี่ไม้</option>
                <option>มู่ลี่อลูมิเนียม</option><option>ฉากกั้นห้อง PVC</option>
            </select>
            <div id="size-container-${id}"></div>
            <button class="btn-add-set" onclick="addSizeField('${id}')">+ เพิ่มชุดในรายการนี้</button>
            <div class="bottom-row">
                <div class="price-display">รวมรายการนี้: <span class="item-price-sum">0</span> บ.</div>
            </div>
        `;
        document.getElementById('itemList').appendChild(itemDiv);
        addSizeField(id);
        updateNumbers();
    }

    function addSizeField(itemId) {
        const container = document.getElementById(`size-container-${itemId}`);
        const type = document.querySelector(`#item-${itemId} .curtain-type`).value;
        const sizeId = Date.now() + Math.random();
        const isFabric = type && curtainPrices[type].calc === "width";
        const div = document.createElement('div');
        div.className = 'size-entry';
        div.id = `size-${sizeId}`;
        div.innerHTML = `
            ${container.children.length > 0 ? `<button class="btn-remove-size" onclick="this.parentElement.remove(); updatePrices();">×</button>` : ''}
            <div class="row">
                <div><label>กว้าง (ม.)</label><input type="text" class="w-val" placeholder="0.00" inputmode="decimal" oninput="resetError(this); updatePrices()"></div>
                <div><label>สูง (ม.)</label><input type="text" class="h-val" placeholder="0.00" inputmode="decimal" oninput="resetError(this); updatePrices()"></div>
            </div>
            <div class="option-box-small" style="display: ${isFabric ? 'flex' : 'none'}">
                <label class="check-item"><input type="checkbox" class="l1-val" onchange="resetBoxError(this); updatePrices()"> ผ้าทึบ</label>
                <label class="check-item"><input type="checkbox" class="l2-val" onchange="resetBoxError(this); updatePrices()"> ผ้าโปร่ง</label>
            </div>
        `;
        container.appendChild(div);
    }

    function updateUIForType(itemId) {
        const type = document.querySelector(`#item-${itemId} .curtain-type`).value;
        const isFabric = type && curtainPrices[type].calc === "width";
        const options = document.querySelectorAll(`#item-${itemId} .option-box-small`);
        options.forEach(opt => opt.style.display = isFabric ? 'flex' : 'none');
    }

    function resetError(el) { el.classList.remove('input-error'); }
    function resetBoxError(el) { el.closest('.option-box-small').classList.remove('option-error'); }
    function removeItem(id) { document.getElementById(`item-${id}`).remove(); updateNumbers(); updatePrices(); }
    function updateNumbers() { document.querySelectorAll('.item-card').forEach((item, index) => { item.querySelector('.item-number').innerText = `รายการที่ ${index + 1}`; }); }

    function updatePrices() {
        let grandTotal = 0;
        document.querySelectorAll('.item-card').forEach(item => {
            const type = item.querySelector('.curtain-type').value;
            let itemSum = 0;
            if (curtainPrices[type]) {
                const config = curtainPrices[type];
                item.querySelectorAll('.size-entry').forEach(size => {
                    let w = parseFloat(size.querySelector('.w-val').value) || 0;
                    let h = parseFloat(size.querySelector('.h-val').value) || 0;
                    
                    if (type === "ฉากกั้นห้อง PVC") {
                        if (w > 0 && w < 1.0) w = 1.0;
                        if (h > 0) {
                            if (h <= 2.0) h = 2.0;
                            else h = Math.ceil((h - 2.0) / 0.20) * 0.20 + 2.0;
                        }
                    }

                    if (config.calc === "width") {
                        if (size.querySelector('.l1-val').checked) itemSum += w * config.main;
                        if (size.querySelector('.l2-val').checked) itemSum += w * config.sheer;
                    } else {
                        let area = w * h * 1.2;
                        if (area > 0 && area < config.min) area = config.min;
                        itemSum += area * config.price;
                    }
                });
            }
            item.querySelector('.item-price-sum').innerText = Math.round(itemSum).toLocaleString();
            grandTotal += itemSum;
        });
        document.getElementById('total-amount-show').innerText = Math.round(grandTotal).toLocaleString() + '.-';
    }

    function validateAndShowSummary() {
        const items = document.querySelectorAll('.item-card');
        if (items.length === 0) { alert("กรุณาเพิ่มรายการอย่างน้อย 1 รายการ"); return; }
        
        let isValid = true;
        let alertMsg = "";

        items.forEach(item => {
            const typeSelect = item.querySelector('.curtain-type');
            if (!typeSelect.value) {
                typeSelect.classList.add('input-error');
                isValid = false;
                alertMsg = "กรุณาเลือกประเภท";
            } else {
                const isFabric = curtainPrices[typeSelect.value].calc === "width";
                item.querySelectorAll('.size-entry').forEach(size => {
                    const w = size.querySelector('.w-val');
                    const h = size.querySelector('.h-val');
                    
                    if (!w.value || parseFloat(w.value) <= 0) { w.classList.add('input-error'); isValid = false; }
                    if (!h.value || parseFloat(h.value) <= 0) { h.classList.add('input-error'); isValid = false; }
                    
                    if (isFabric) {
                        const optBox = size.querySelector('.option-box-small');
                        if (!size.querySelector('.l1-val').checked && !size.querySelector('.l2-val').checked) {
                            optBox.classList.add('option-error');
                            isValid = false;
                            if (!alertMsg) alertMsg = "กรุณาเลือกอย่างน้อย 1 รายการ (ทึบ/โปร่ง)";
                        }
                    }
                });
                if (!isValid && !alertMsg) alertMsg = "กรุณาใส่ขนาด ความกว้าง/สูงให้ถูกต้อง";
            }
        });

        if (!isValid) { alert(alertMsg || "กรุณากรอกข้อมูลให้ครบถ้วน"); return; }
        showSummary();
    }

    function showSummary() {
        const items = document.querySelectorAll('.item-card');
        let html = ''; let grandTotal = 0;
        items.forEach((item, index) => {
            const room = item.querySelector('.room-name').value;
            const type = item.querySelector('.curtain-type').value;
            const config = curtainPrices[type];
            let itemTotal = 0; let detailsHtml = '';
            const badgeColor = config.color || '#34495e';

            item.querySelectorAll('.size-entry').forEach((size, sIdx) => {
                let wInput = parseFloat(size.querySelector('.w-val').value) || 0;
                let hInput = parseFloat(size.querySelector('.h-val').value) || 0;
                let wCalc = wInput; let hCalc = hInput;
                let warning = '';
                
                if (type === "ฉากกั้นห้อง PVC") {
                    if (wInput > 0 && wInput < 1.0) {
                        wCalc = 1.0;
                        warning += `<span class="min-warning">* ความกว้างขั้นต่ำคิดที่ 1.00 ม.</span>`;
                    }
                    if (hInput > 0) {
                        if (hInput <= 2.0) hCalc = 2.0;
                        else hCalc = Math.ceil((hInput - 2.0) / 0.20) * 0.20 + 2.0;
                    }
                }

                let unitPrice = 0;
                if (config.calc === "width") {
                    let sub = [];
                    if (size.querySelector('.l1-val').checked) {
                        let p = wCalc * config.main; unitPrice += p;
                        sub.push(`<span>- ผ้าทึบ</span> <span>${Math.round(p).toLocaleString()} บ.</span>`);
                    }
                    if (size.querySelector('.l2-val').checked) {
                        let p = wCalc * config.sheer; unitPrice += p;
                        sub.push(`<span>- ผ้าโปร่ง</span> <span>${Math.round(p).toLocaleString()} บ.</span>`);
                    }
                    detailsHtml += `<div style="margin-top:10px; border-bottom:1px solid #f9f9f9; padding-bottom:5px;">
                        <div style="font-size:12px; font-weight:bold; color:#333;">ชุดที่ ${sIdx+1}: ${wInput}x${hInput} ม.</div>
                        ${sub.map(s => `<div class="summary-detail">${s}</div>`).join('')}
                        ${warning}
                    </div>`;
                } else {
                    let area = wCalc * hCalc * 1.2;
                    if (area > 0 && area < config.min) {
                        area = config.min;
                        warning += `<span class="min-warning">* ขนาดขั้นต่ำคิดที่ ${config.min.toFixed(2)} ตร.หลา</span>`;
                    }
                    unitPrice = area * config.price;
                    detailsHtml += `<div style="margin-top:10px; border-bottom:1px solid #f9f9f9; padding-bottom:5px;">
                        <div class="summary-detail"><span>ชุดที่ ${sIdx+1}: ${wInput}x${hInput} ม.</span> <span>${Math.round(unitPrice).toLocaleString()} บ.</span></div>
                        ${warning}
                    </div>`;
                }
                itemTotal += unitPrice;
            });
            html += `<div class="summary-item"><div class="summary-title"><div><span class="type-badge" style="background:${badgeColor}">${type}</span>${room || 'รายการที่ '+(index+1)}</div><span>${Math.round(itemTotal).toLocaleString()} บ.</span></div>${detailsHtml}</div>`;
            grandTotal += itemTotal;
        });
        document.getElementById('summaryList').innerHTML = html;
        document.getElementById('summaryGrandTotal').innerText = `รวมทั้งสิ้น: ${Math.round(grandTotal).toLocaleString()} บาท`;
        document.getElementById('summaryModal').style.display = 'flex'; // แสดง Modal อยู่ตรงกลาง
    }

    function saveImage() {
        const area = document.getElementById('capture-area');
        const btnIcon = document.querySelector('.btn-save-icon');
        btnIcon.classList.add('hide-on-capture');
        const originalScrollTop = area.scrollTop;

        html2canvas(area, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff",
            height: area.scrollHeight,
            windowHeight: area.scrollHeight,
            onclone: (clonedDoc) => {
                const clonedArea = clonedDoc.getElementById('capture-area');
                clonedArea.style.overflow = 'visible';
                clonedArea.style.height = 'auto';
                clonedArea.style.maxHeight = 'none';
            }
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ใบสรุปราคา.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            btnIcon.classList.remove('hide-on-capture');
            area.scrollTop = originalScrollTop;
        }).catch(err => {
            alert("บันทึกไม่สำเร็จ");
            btnIcon.classList.remove('hide-on-capture');
        });
    }

    function closeModal() { document.getElementById('summaryModal').style.display = 'none'; }
    addItem();
</script>
</body>
</html>
